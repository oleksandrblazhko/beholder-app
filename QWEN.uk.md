# Додаток Beholder - Контекст Розробки

## Огляд проекту

Beholder — це інструментарій комп'ютерного зору (CV) для створення тангібельних контролерів для інтерактивних комп'ютерних систем. Він дозволяє дизайнерам створювати фізичні вхідні пристрої, оснащені маркерами комп'ютерного зору. Спостерігаючи за властивостями цих маркерів, система комп'ютерного зору може виявляти фізичні взаємодії. Beholder надає редактор програмного забезпечення, який дозволяє відображати поведінку маркерів комп'ютерного зору на події клавіш; таким чином підключаючи тангібельні контролери, що керуються комп'ютерним зором, до будь-якого програмного забезпечення, яке реагує на введення з клавіатури.

Додаток побудований як електронний додаток за допомогою Cycle.js (функціональний реактивний фреймворк) з TypeScript. Він інтегрує нативні компоненти для обробки комп'ютерного зору та емуляції клавіатури.

## Архітектура

### Фронтенд (Interface/)
- **Фреймворк**: Cycle.js з TypeScript
- **Управління станом**: Власна модель командного редуктора з функціональністю скасування/повторення
- **Компоненти UI**: Власний візуальний інтерфейс програмування на основі вузлів
- **Інструмент збірки**: esbuild для збирання TypeScript у JavaScript

### Бекенд (Native/)
- **Комп'ютерне бачення**: Засноване на OpenCV виявлення маркерів (LocalMarkerDetection)
- **Емуляція клавіатури**: Нативні модулі для емуляції подій клавіатури
- **Мобільна інтеграція**: Комунікація через UDP для мобільних джерел

### Основні компоненти

1. **Система вузлів**: Візуальний інтерфейс програмування з різними типами вузлів:
   - Панель виявлення (коренева панель для всіх вузлів)
   - Виявлення маркера (захоплює значення маркера)
   - Число (вузли цілочисельних значень)
   - Натискання/Тап клавіші (тригери подій клавіатури)
   - Логічні елементи (NOT, AND, OR, елементи порівняння)

2. **Нативні драйвери**: Міст між фронтендом та нативною функціональністю:
   - WebcamDetectionDriver: Управляє потоком камери та виявленням маркерів
   - ProgramDriver: Виконує граф вузлів та обробляє події клавіатури

3. **Управління станом**: Засноване на командах з можливістю скасування/повторення

## Збирання та запуск

### Передумови
- Node.js
- OpenCV 4.7 (з налаштованими змінними середовища)

### Команди налаштування
```bash
# Встановити залежності JavaScript
npm install

# Зібрати кодову базу JavaScript
npm run build

# Запустити додаток
npm start

# Режим розробки (автоматично перезбирає при змінах)
npm run dev
# Потім в окремому терміналі:
npm start
```

### Особливості налаштування для платформ
**Windows:**
- Встановити Node.js з офіційного сайту
- Встановити OpenCV 4.7 з [офіційного інсталятора](https://opencv.org/releases/) для Windows
- Рекомендований шлях встановлення: розпакувати архів у зручну директорію (наприклад, `C:\opencv`)
- Обов'язково додайте шлях до папки `bin` з OpenCV у системну змінну середовища PATH, наприклад, 
   - для Win: set PATH "%PATH%;C:\opencv\build\x64\vc16\bin"
   - для Bash: export PATH="$PATH:/c/opencv/build/x64/vc16/bin" та зберегди у bash: nano ~/.bash_profile
- перевірка роботи середовища, наприклад, через утиліту opencv_interactive-calibration для шаблонів:
   - Black-white chessboard (шахівниця) - https://github.com/opencv/opencv/blob/4.x/doc/pattern.png
   - Symmetrical circle pattern (кола) - https://github.com/opencv/opencv/blob/4.x/doc/acircles_pattern.png
   - chAruco, chessboard with Aruco markers (шахівниця з маркерами Aruco ) - https://github.com/opencv/opencv/blob/4.x/doc/charuco_board_pattern.png
     opencv_interactive-calibration -t=charuco -w=5 -h=7 -sl=0.022 -ml=0.011
    де: -w 5 і -h 7 - кількість внутрішніх кутів (на 1 менше за кількість квадратів по кожній осі)
     - -sl 0.022 - довжина сторони квадратів (22 мм = 0.022 м)
     - -ml 0.011 - довжина сторони маркерів ArUco (11 мм = 0.011 м)
     - -d 17 - словник DICT_5X5_1000
     Після запуску утиліти:
     1. Наведіть камеру на шаблон ChArUco з різних кутів
     2. Натискайте пробіл або Enter для збору зображень
     3. Після збору достатньої кількості зображень натисніть 'c' для калібрування

- Налаштуйте змінні середовища для OpenCV (див. посібник з налаштування змінних середовища)
- Замініть папку Native бінарними файлами для Windows з посилання 
https://o365coloradoedu-my.sharepoint.com/:u:/g/personal/pegy8859_colorado_edu/EYBRymB2_sBGlkfNLS3GO0UB2dru28osh3_rWVrHQUybJA?e=JJ5ycQ

**Mac:**
- Встановити OpenCV через Homebrew: `brew install opencv`
- Замінити папку Native бінарними файлами для Mac

## Угоди розробки

### Структура коду
- **Interface/**: Містить весь код фронтенду (компоненти Cycle.js, управління станом)
- **Native/**: Містить нативні модулі для комп'ютерного зору та емуляції клавіатури
- **Interface/Components/**: Повторно використовувані компоненти UI
- **Interface/StateManagement/**: Командний редуктор та логіка скасування/повторення
- **Interface/NativeDrivers/**: Мости до нативної функціональності

### Патерни фреймворку
- **Cycle.js**: Функціональне та реактивне програмування з потоками (xstream)
- **Патерн команд**: Дії відправляються до центрального редуктора
- **Візуальний інтерфейс на основі вузлів**: Графічний інтерфейс програмування з перетягуваними, з'єднуваними вузлами
- **Незмінювані оновлення**: Зміни стану відбуваються через командний редуктор

### Тестування
- Не знайдено явних файлів тестів у репозиторії
- Ручне тестування через візуальний інтерфейс

## Ключові технології

- **Electron**: Кросплатформний фреймворк для настільних додатків
- **Cycle.js**: Функціональний та реактивний JavaScript фреймворк
- **xstream**: Бібліотека реактивних потоків
- **Ramda**: Утилітна бібліотека функціонального програмування
- **TypeScript**: Типізована надбудова над JavaScript
- **esbuild**: Швидкий інструмент збирання JavaScript
- **OpenCV**: Бібліотека комп'ютерного зору для виявлення маркерів
- **Нативні модулі**: Прив'язки C++ для операцій на рівні системи

## Стан проекту

Проект знаходиться на ранній стадії розробки (версія 0.0.2) і зосереджується на забезпеченні візуального інтерфейсу програмування для підключення виявлення маркерів комп'ютерного зору до подій клавіш. Система дозволяє користувачам створювати складні шаблони взаємодії, з'єднуючи різні типи вузлів у графічному інтерфейсі.

## Загальні завдання розробки

1. **Додавання нових типів вузлів**: Розширити модуль CreateNode і додати до NodePalette
2. **Модифікація алгоритмів виявлення**: Оновити нативний модуль LocalMarkerDetection
3. **Розширення відображення клавіш**: Оновити утиліти відображення клавіш у NativeDrivers/Utils/
4. **Налаштування UI**: Змінити CSS у Assets/Styles/ та компоненти у Components/

## Усунення несправностей

- Проблеми з потоком камери: Завершити роботу та перезапустити додаток
- Помилки нативних модулів: Переконайтеся, що OpenCV правильно встановлений і знаходиться в PATH
- Проблеми з виявленням маркерів: Перевірте освітлення та видимість маркерів

## Генерація ArUco-маркерів
https://github.com/han-xudong/tags-generator
